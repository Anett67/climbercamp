{% extends 'base.html.twig' %}

{% block title %}{{ event.title }}{% endblock %}

{% block pageTitle %}{{ event.title }}{% endblock %}

{% block body %}

{% include 'topLinks.html.twig' %}    

{% include 'flashMessages.html.twig' %}

<div class="row justify-content-center justify-content-lg-end mt-5 mb-5">
    <div class=" event-block col-11 col-md-9 justify-content-center">

        <div class="row event-header {% if event.image %} justify-content-center {% endif %}">
            <!-- Afficher l'image lié à l'évènement si il y en a -->
            {% if event.image %}
                <div class="col-10 col-md-5 pt-2 pb-2">
                    <img src="{{ asset('upload/events/' ~ event.image) }}" alt="" class="event-image">
                </div>
            {% endif %}

            <div class="col-10 col-md-5 d-flex flex-column justify-content-around p-2">
                <!-- Ville, lieu et date -->
                <h5>{{ event.ville.nom }}</h5>
                <h6>{{ event.location }}</h6>
                <span class="date mb-2" >le {{ event.eventDate|date("d/m/Y à H:i") }}</span>

                <!-- Le bloc qui affiche le nom et la photo de l'auteur -->
                <p>Partagé par: <a class="postedBy-link" href="{{ path('single-user', {'id': event.postedBy.id}) }}">{{ event.postedBy.firstName }} {{ event.postedBy.LastName }} </a></p>
                
                <!-- Lien pour enregistrer ou supprimer l'évènement -->
                {% if event in app.user.savedEvents %}
                    <span class="saved-message mt-2">Vous avez sauvegardé cet évènement</span> 
                    <a class="btn save-button mt-2" href="{{ path('event-remove', {'id': event.id}) }}">SUPPRIMER DE MA LISTE</a>
                {% else %}
                    <a class="btn save-button" href="{{ path('event-save', {'id': event.id}) }}">ENREGISTRER</a>
                {% endif %}
            </div>
        </div>

        <!-- Le nombre des personnes intéressées -->
        <div class="row justify-content-center">
            <div class="col-10">
                <a class="interested-persons" href="{{ path('event-users', {'id': event.id}) }}">{{ event.interestedUsers|length }} personnes sont intéressées </a>
            </div>
        </div>

        <!-- Description de l'évènement -->
        <div class="row justify-content-center description mt-5 mb-5">
            <div class="col-10">
               <h3>Détails</h3> 
            </div>
            <div class="col-10">
                <p>{{ event.description }}</p>
            </div>
        </div>

        <!-- Commentaires -->
        <div class="row justify-content-center comment-section pb-5">
            <div class="col-10">
                <div class="row justify-content-center align-items-end form-block">
                    
                    <!-- Le formulaire pour envoyer un nouveau commentaire -->
                    <div class="col-12">
                        {{ form_start(form) }}
                            {{ form_widget(form) }}
                    </div>
                    <div class="col-12">
                        <input type="submit" value="Envoyer" class="btn submit-button mb-5 w-100" >   
                        {{ form_end(form) }}
                    </div>
                </div>
                
                <h6 class=" mb-2">Commentaires ({{ comments|length }})</h5>

                <!-- La liste des commentaires -->
                {% for comment in comments %}
                    <div class="row justify-content-center mb-3">
                        <div class="col-12 comment-block">
                            <!-- Photo et nom de l'auteur, temps passé depuis a publication -->
                            <div class="row justify-content-center align-items-center p-2">
                                <div class="col-2 col-md-1">
                                    <div class="img-cadre">
                                        {% if comment.postedBy.image %}
                                            <img src="{{ asset('upload/users/' ~ comment.postedBy.image) }}" alt="" class="postedByImage">
                                        {% else %}
                                            <img src="{{ asset('upload/default.png') }}" alt="" class="postedByImage">
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-6 col-md-8 name">
                                    <a class="name" href="{{ path('single-user', {'id': comment.postedBy.id}) }}">{{ comment.postedBy.firstName }} {{ comment.postedBy.lastName }}</a>
                                </div>
                                <div class="col-4 col-md-3 text-right p-2">
                                    <span class="date">{{ comment.postedAt|ago }}</span>
                                    
                                    <!-- Lien de modification et suppression si l'utilisateur connecté est l'auteur du commentaire -->
                                    {% if comment.postedBy.id == app.user.id %}
                                        <div class="row justify-content-end comment-icons no-gutters">
                                            <div class="col-6">
                                                <a href=""><i class="fas fa-edit m-2 m-md-3"></i></a>
                                            </div>
                                            <div class="col-6 col-md-4 text-right">
                                                <a href="{{ path('eventcomment-delete', {'id': comment.id}) }}" onclick="return confirm('Confirmer la suppression?')">
                                                    <i class="fas fa-trash-alt m-2 m-md-3">
                                                        <form method="POST" style="display:inline-block" action="{{ path('eventcomment-delete', {'id': comment.id}) }}">
                                                            <input type="hidden" name="_method" value="delete">
                                                            <input type="hidden" name="_token" value="{{ csrf_token('SUP' ~ comment.id) }}">
                                                            <input type="submit" value="" > 
                                                        </form>
                                                    </i>
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}
                                
                                </div>   
                            </div>

                            <!-- Texte du commentaire -->
                            <div class="row">
                                <div class="col-11 ml-3 mr-3">
                                    <p class="commentBody">{{ comment.body }}</p>
                                </div>
                            </div>
                            <div class="row justify-content-around align-items-center p-3">
                                
                                <!-- Nombre de j'aimes et nombre des réponses -->
                                <div class="col-12 col-md-6 commentLike-count">
                                    <span class="like-count">{{ comment.eventCommentLikes|length }}</span>
                                        J'aimes | 
                                    <span class="commentReplyCount">{{ comment.eventCommentReplies|length }}</span> Réponses
                                </div>

                                <!-- Bouton j'aime -->
                                <div class="col-12 col-md-3 text-right mt-2">
                                    <a class="btn commentLike-button" href="{{ path('event-comment-like', {'id': comment.id}) }}">
                                        <span class="{% if comment.isLikedByUser(app.user) %}liked{% endif %}">
                                            {% if comment.isLikedByUser(app.user) %}
                                                Je n'aime plus
                                            {% else %}
                                                J'aime
                                            {% endif %}
                                        </span>  
                                    </a>
                                </div>

                                <!-- Lien qui affiche les réponses au commentaire et le formulaire pour envoyer une nouvelle réponse -->
                                <div class="col-12 col-md-3 text-right mt-2">
                                    <a href="{{ path('event-comment-replies', {'id': comment.id}) }}" class="btn reply-button w-100">Réponses</a>
                                </div>
                            </div>

                            <!-- Le conteneur ou les réponses apparaissent (AJAX) -->
                            <div class="comment-replies row"></div>
                        </div>
                    </div>
                {% endfor %}
                    
                </div>
            </div>
        </div>

       
        
    </div>
</div>


{% endblock %}